<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
		<title>jQuery UI Кластер-аналіз</title>
		<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" media="screen" href="lib/jq-grid/css/ui.jqgrid.css" />
    <link type="text/css" href="css/style.css" rel="stylesheet" />
		<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="lib/jq-grid/js/i18n/grid.locale-en.js" type="text/javascript"></script>
    <script src="lib/jq-grid/js/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="lib/jquery.autoscroll.packed.js" type="text/javascript"></script>

		<script type="text/javascript">
      // Загрузка зображення
      jQuery.fn.ieiLoadImage = function(dataBase) {
        //Навчальна матриця
        function trainingMatrixCreate(src) {
          var image = new Image();
          image.onload = function() {
            var canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            var context = canvas.getContext('2d');
            context.drawImage(image, 0, 0);
            var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            var matrixNum = dataBase.trainingMatrix.length;
            dataBase.trainingMatrix[matrixNum] = Array();
            for(var x = 0; x < canvas.width; x++){
              dataBase.trainingMatrix[matrixNum][x] = Array();
              for(var y = 0; y < canvas.height; y++) {
                var index = (y*imageData.width + x) * 4,
                red = imageData.data[index],
                green = imageData.data[index + 1],
                blue = imageData.data[index + 2],
                alpha = imageData.data[index + 3];
                // Формула яскравості: Y = 0.299 * R + 0.587 * G + 0.114 * B
                //var bright = Math.round(0.299*red + 0.587*green + 0.114*blue);
                var bright = Math.floor(0.299*red + 0.587*green + 0.114*blue); // (<= 255)
                dataBase.trainingMatrix[matrixNum][x][y] = bright;
              }
            }
          }
          image.src = src;
          return true;
        }
        
        function handleFileSelect(evt) {
          evt.stopPropagation();
          evt.preventDefault();
          var files = evt.dataTransfer.files;
          var dropZone = $(this);
          for (var i = 0, f; f = files[i]; i++) {
            if (!f.type.match('image.*')) {
              continue;
            }
            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    dropZone.append('<span><img class="thumb" src="' +e.target.result+
                                    '" title="' +theFile.name+ '"/></span>');
                    $( ".thumb" ).draggable({ axis: 'x' }); // Фокус-покус ;)
                    trainingMatrixCreate(e.target.result);
                };
            })(f);
            reader.readAsDataURL(f);
          }
        }
        function handleDragOver(evt) {
          evt.stopPropagation();
          evt.preventDefault();
        }
        var dropZone = $(this)[0];
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
        return true;
      }
      
      // Виведення матриці зображенням
      jQuery.fn.ieiDrawImage = function(matrix) {
        $(this).append('<canvas></canvas>');
        var canvas = $('canvas:last-child', this)[0];
        canvas.width=matrix.length;
        canvas.height=matrix[0].length;
        var ctx = canvas.getContext('2d');
        var canvasData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for(var i = 0; i < canvasData.width; i++){
          for(var j = 0; j < canvasData.height; j++){
            var idx = (i + j * canvas.width) * 4;
            canvasData.data[idx + 0] = matrix[i][j]; // RED - красный
            canvasData.data[idx + 1] = matrix[i][j]; // GREEN - зелёный
            canvasData.data[idx + 2] = matrix[i][j]; // BLUE - синий
            canvasData.data[idx + 3] = 255; // ALPHA - альфа-канал
          }
        }
        ctx.putImageData(canvasData, 0, 0);
      }
      jQuery.fn.ieiDrawImages = function(matrix){
        $(this).empty();
        for(var i = 0; i < matrix.length; i++)
          $(this).ieiDrawImage(matrix[i]);
      }
      jQuery.fn.ieiDrawBinaryImages = function(matrix){
        $(this).empty();
        for(var i = 0; i < matrix.length; i++) {
          var binary = Array();
          for(var j = 0; j < matrix[i].length; j++) {
            binary[j] = Array();
            for(var k = 0; k < matrix[i][j].length; k++)
              binary[j][k] = Math.abs(matrix[i][j][k]-1)*255;
          }
          $(this).ieiDrawImage(binary);
        }
      }
      jQuery.fn.ieiDrawEVImages = function(matrix){
        $(this).empty();
        for(var i = 0; i < matrix.length; i++) {
          binary = Array();
          for(var j = 0; j < matrix[i].length; j++) {
            binary[j] = Array();
            for(var k = 0; k < 30; k++) {
              binary[j][k] = Math.abs(matrix[i][j]-1)*255;
            }
          }
          $(this).ieiDrawImage(binary);
        }
      }
      
      // Побудова таблиці із масива
      jQuery.fn.jqGridFromArray = function(arr) {
        var colModel = [], colNames = [];
        for(var i = 0; i <= arr.length; i++) {
          colNames[i] = i;
          if(i == 0)
            colNames[i] = '№';
          var width = 15;
          if(i == arr.length)
            width = 35;
          colModel[i] = {name:'id'+i,index:'id'+i, width:width, height: 15, sortable: false};
        }
        jQuery(this).jqGrid({
          datatype: "local",
          height: 250,
            colNames: colNames, //['Inv No','Date', 'Client', 'Amount','Tax','Total','Notes'],
            colModel: colModel,
            caption: "Масив елементів"
        });
        var mydata = [];
        for(var i = 0; i < arr.length; i++) {
          mydata[i] = {};
          mydata[i].id0 = i+1;
          for(var j = 0; j <= arr[i].length; j++) {
            eval('mydata['+i+'].id'+(j+1)+' = '+ arr[i][j]);
          }
        }
        for(var i=0;i<=mydata.length;i++)
          jQuery(this).jqGrid('addRowData',i+1,mydata[i]);
        $.autoscroll.init({step: 200});
      }
      jQuery.fn.ieiPrintTables = function(matrix){
        for(var i = 0; i < matrix.length; i++) {
          $(this).append('<table id="tm'+i+'"></table>');
          $('#tm'+i).jqGridFromArray(DataBase.trainingMatrix[i]);
        }
      }
      
      jQuery.fn.ieiBinEtalon = function(dataBase){
        for(var i = 0; i < dataBase.trainingMatrix.length; i++) {
          dataBase.binaryMatrix[i] = Array();
          dataBase.etalonVector[i] = Array();
          for(var j = 0; j < dataBase.trainingMatrix[i].length; j++) {
            dataBase.binaryMatrix[i][j] = Array();
            var height = dataBase.trainingMatrix[i][j].length;
            var dk = 0; // Середнє значення по стовпцю
            var ev = 0;
            for(var k = 0; k < height; k++) {
              dk += dataBase.trainingMatrix[i][j][k];
            }
            dk /= height;
            var ndk = dk - dataBase.admission, vdk = dk + dataBase.admission;
            for(var k = 0; k < height; k++) {
              var bright = dataBase.trainingMatrix[i][j][k];
              var bin = (ndk <= bright && vdk >= bright)?1:0;
              $('#dialog-message').append(bright);
              dataBase.binaryMatrix[i][j][k] = bin;
              ev += bin;
            }
            ev /= height;
            dataBase.etalonVector[i][j] = (ev >= dataBase.selectionLevel) ? 1 : 0;
          }
        }
      }
      
      jQuery.fn.inputSlider = function(input, options){
        options = jQuery.extend({
          value: 40,
          min: 0,
          max: 100,
          step: 1
        }, options);
        $(this).slider({
          value:options.value,
          min: options.min,
          max: options.max,
          step: options.step,
          slide: function(event, ui) {
            input.val(ui.value);
            BinEtalon();
          }
        });
        input.val($(this).slider("value"));
      }
      
      // Масив |PARA| кодових відстаней між геометричними цетрами EV
      jQuery.fn.ieiCodeDistance = function(dataBase){
        for(var i = 0; i < dataBase.trainingMatrix.length; i++) {
          dataBase.codeDistance[i] = Array();
          var width = dataBase.etalonVector[i].length;
          for(var j = 0; j < dataBase.trainingMatrix.length; j++) {
            dataBase.codeDistance[i][j] = 0;
            for(var k = 0; k < width; k++)
              dataBase.codeDistance[i][j] += (dataBase.etalonVector[i][k] + dataBase.etalonVector[j][k]) % 2;
            //console.log(dataBase.codeDistance[i][j]);
          }
        }
      }
      
      // Запуск методів, відповідальних за навчання
      function BinEtalon() {
        DataBase.admission = $('#admission').val(); // Дельта
        DataBase.selectionLevel = $('#sel-level').val(); // Ro
        $('#binary-matrix').ieiBinEtalon(DataBase);
        $('#binary-matrix').ieiDrawBinaryImages(DataBase.binaryMatrix);
        $('#etalon-matrix').ieiDrawEVImages(DataBase.etalonVector);
        $('#binary-matrix').ieiCodeDistance(DataBase);
        return false;
      }
      
      // Запуск всіх елементів сторінки
      var DataBase = {};
      $(function(){
				$('#tabs').tabs();
        $('button').button();
        
        //slider
        $('#admission-slider').inputSlider($('#admission'));
        $('#sel-level-slider').inputSlider($('#sel-level'), {value: 0.53, min: 0, max: 1, step: 0.01});
        
        DataBase.trainingMatrix = Array(); // Навчальна матриця
        $('#drop-zone').ieiLoadImage(DataBase);
        $('.matrix.training button').click(function(){
          $('#training-matrix').ieiPrintTables(DataBase.trainingMatrix);
        });
        /*
        $('.distance button').click(function(){
          $('#code-distance').ieiPrintTables(DataBase.trainingMatrix);
        });
        */
        DataBase.binaryMatrix = Array(); // Бінарна матриця
        DataBase.etalonVector = Array(); // Еталонний вектор
        DataBase.codeDistance = Array(); // Масив кодових відстаней
        $('.params button').click(function(){
          BinEtalon()
        });
			});
		</script>
	</head>
	<body>
		<div id="tabs">
			<ul>
				<li><a href="#tabs-1">Навчальна матриця</a></li>
				<li><a href="#tabs-2">Навчання системи</a></li>
        <li><a href="#tabs-3">Точнісні характеристики</a></li>
        <li><a href="#tabs-4">Екзамен</a></li>
			</ul>
			<div id="tabs-1">
      
        <div id="drop-zone">
          <span class="instruction">Перетягніть сюди зображення для розпізнавання</span>
        </div>
        <div class="matrix training">
          <h3>Навчальні матриці</h3>
          <button>Відобразити</button>
          <div class="clr"></div>
          <div id="training-matrix"></div>
        </div>      
      </div>
			<div id="tabs-2">
        <div class="params">
          <div>
            <span title="Дельта допусків">&#916;</span> =
            <!--input type="number" step="1" min="1" id="admission" value="40"></input-->
            &plusmn;<input type="text" id="admission"></input>
            <div id="admission-slider" class="slider"></div>
          </div>
          <div>
            <span title="Рівень селекції">&rho;</span> = 
            <input type="text" id="sel-level"></input>
            <div id="sel-level-slider" class="slider"></div>
          </div>
          <button>Провести навчання</button>
        </div>
        <div class="clr"></div>
        <div class="matrix binary">
          <h3>Бінарні матриці</h3>
          <!--button>Відобразити</button-->
          <div class="clr"></div>
          <div id="binary-matrix"></div>
        </div>
        <div class="matrix etalon">
          <h3>Еталонні вектори</h3>
          <!--button>Відобразити</button-->
          <div class="clr"></div>
          <div id="etalon-matrix"></div>
        </div>
        <div class="distance">
          <h3>Масив кодових відстаней</h3>
          <!--button>Відобразити</button-->
          <div class="clr"></div>
          <div id="code-distance"></div>
        </div>
      </div>
			<div id="tabs-3">Далі буде...</div>
      <div id="tabs-4">Далі буде...</div>
		</div>

<table id="testing"></table>
<button id="test">Тестувати</button>
<div id="dialog-message" title="Тестування елементів сторінки">
  На даний момент нічого тестувати! ;)
</div>
<script type="text/javascript">
  $( "#dialog-message" ).dialog({
    autoOpen: false,
    modal: true,
    buttons: {
      Ok: function() {
        $( this ).dialog( "close" );
      }
    }
  });
$('#test').click(function(){
  //alert('Testing started');
  
  $('#dialog-message').dialog('open');
  
  
  //alert('Testing ended');
  }
);
</script>
	</body>
</html>


